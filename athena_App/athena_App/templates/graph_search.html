{% extends "layout.html" %}

{% block content %}
<script src="/static/scripts/pace.min.js"></script>

<script src="/static/scripts/nifty.min.js"></script>
<script src="/static/scripts/icons.js"></script>

<script src="/static/scripts/echarts.js"></script>
<script src="/static/scripts/tags.js"></script>


<div class="container">
    <div class="row">
        <center>
            <div class="input-group">
                <input type="text" id="search" class="form-control input-lg" placeholder="请输入你要检索的实体...">
                <span class="input-group-addon btn btn-mint" onclick="search()">搜索</span>
            </div>
        </center>
    </div>
</div>

<!--
<div class="container">
    <div class="row">
        <div class="span12">
            <div class="alert alert-success">
                <button type="button" class="close" data-dismiss="alert">×</button>
                <h4>
                    您所查询的是：<em>我在微博买通过熟人扫码买票感觉被骗了，现在有类似案例吗？</em>
                </h4> <strong>您的提问似乎是在查询一个案例，我们已为您找到了一个类似的案例！</strong>
            </div>
        </div>
    </div>
</div>
-->
<!--
<div class="container">
    <div class="row">
        <div class="col-md-4 col-sm-5">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>属性</th>
                        <th>值</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>诈骗方式</td>
                        <td>微博</td>
                    </tr>
                    <tr>
                        <td>金额</td>
                        <td>3110元+3110元+3760元</td>
                    </tr>
                </tbody>
            </table>
            <h3>案例简要概括</h3>
            <p>
                通过微博，小王认识了一个叫“快乐小票”的人，骗子声称自己正好有两张张学友北京演唱会的门票，价格为3760元，小王觉得可以接受这个价格，加上骗子微博是“加V认证”的，
                也就没有对此产生怀疑，随后便按要求添加了对方微信。通过了微信好友验证后，骗子发给小王一个收款码，称直接扫码付款即可。
                在转账成功后，骗子却以演唱会门票需要激活为由，让小王再转账支付3110元，并承诺激活后钱会立刻返还，于是小王按对方要求再次进行了转账。
                但随后骗子又以未备注，暂不能激活为由，要求小王重新转款3110元。在小王完成了第三次转账后，骗子却依然找借口要让小王继续转账2000元，这时的小王才反应过来自己遭遇了诈骗。
                随后小王立即停止转账，向公安机关报案。
            </p>
        </div>
        <div class="col-md-8 col-sm-2">
            <script type="text/javascript">

                var links =
                    [
                        { source: '小王', target: '快乐小票', 'rela': '_微博', type: 'resolved' },
                        { source: '快乐小票', target: '张学友演唱会门票', 'rela': '拥有', type: 'resolved' },
                        { source: '快乐小票', target: '微博V认证', 'rela': '拥有', type: 'resolved' },
                        { source: '小王', target: '付款码', 'rela': '_扫描', type: 'resolved' },
                        { source: '快乐小票', target: '付款码', 'rela': '拥有', type: 'resolved' },
                        { source: '犯罪嫌疑人', target: '快乐小票', 'rela': '拥有', type: 'resolved' },
                        { source: '3110元人民币', target: '犯罪嫌疑人', 'rela': '转入', type: 'resolved' },
                        { source: '小王', target: '3110元人民币', 'rela': '转出', type: 'resolved' },
                        { source: '小王', target: '张学友演唱会门票', 'rela': '需要', type: 'resolved' },
                        { source: '张学友演唱会门票', target: '3760元人民币', 'rela': '价格', type: 'resolved' },
                    ];

                var nodes = {};
                links.forEach(function (link) {
                    link.source = nodes[link.source] || (nodes[link.source] = { name: link.source });
                    link.target = nodes[link.target] || (nodes[link.target] = { name: link.target });
                });
                var width = 700, height = 700;
                var force = d3.layout.force()
                    .nodes(d3.values(nodes))
                    .links(links)
                    .size([width, height])
                    .linkDistance(200)
                    .charge(-1500)
                    .on("tick", tick)
                    .start();
                var svg = d3.select("div[class='col-md-8 col-sm-2']").append("svg")
                    .attr("width", width)
                    .attr("height", height);
                var marker =
                    svg.append("marker")
                        .attr("id", "resolved")
                        .attr("markerUnits", "userSpaceOnUse")

                        .attr("viewBox", "0 -5 10 10")
                        .attr("refX", 32)
                        .attr("refY", -1)
                        .attr("markerWidth", 12)
                        .attr("markerHeight", 12)
                        .attr("orient", "auto")
                        .attr("stroke-width", 2)
                        .append("path")
                        .attr("d", "M0,-5L10,0L0,5")
                        .attr('fill', '#000000');
                var edges_line = svg.selectAll(".edgepath")
                    .data(force.links())
                    .enter()
                    .append("path")
                    .attr({
                        'd': function (d) { return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y },
                        'class': 'edgepath',
                        'id': function (d, i) { return 'edgepath' + i; }
                    })
                    .style("stroke", function (d) {
                        var lineColor;
                        lineColor = "#B43232";
                        return lineColor;
                    })
                    .style("pointer-events", "none")
                    .style("stroke-width", 0.5)
                    .attr("marker-end", "url(#resolved)");
                var edges_text = svg.append("g").selectAll(".edgelabel")
                    .data(force.links())
                    .enter()
                    .append("text")
                    .style("pointer-events", "none")
                    .attr({
                        'class': 'edgelabel',
                        'id': function (d, i) { return 'edgepath' + i; },
                        'dx': 80,
                        'dy': 0
                    });
                edges_text.append('textPath')
                    .attr('xlink:href', function (d, i) { return '#edgepath' + i })
                    .style("pointer-events", "none")
                    .text(function (d) { return d.rela; });
                var circle = svg.append("g").selectAll("circle")
                    .data(force.nodes())
                    .enter().append("circle")
                    .style("fill", function (node) {
                        var color;
                        var link = links[node.index];
                        color = "#9999FF";
                        return color;
                    })
                    .style('stroke', function (node) {
                        var color;
                        var link = links[node.index];
                        color = "#FFFF66";
                        return color;
                    })
                    .attr("r", 28)
                    .on("click", function (node) {
                        edges_line.style("stroke-width", function (line) {
                            console.log(line);
                            if (line.source.name == node.name || line.target.name == node.name) {
                                return 4;
                            } else {
                                return 0.5;
                            }
                        });
                    })
                    .call(force.drag);
                var text = svg.append("g").selectAll("text")
                    .data(force.nodes())
                    .enter()
                    .append("text")
                    .attr("dy", ".35em")
                    .attr("text-anchor", "middle")
                    .style('fill', function (node) {
                        var color;
                        var link = links[node.index];
                        color = "#242424";
                        return color;
                    }).attr('x', function (d) {
                        var re_en = /[a-zA-Z]+/g;
                        if (d.name.match(re_en)) {
                            d3.select(this).append('tspan')
                                .attr('x', 0)
                                .attr('y', 2)
                                .text(function () { return d.name; });
                        }

                        else if (d.name.length <= 4) {
                            d3.select(this).append('tspan')
                                .attr('x', 0)
                                .attr('y', 2)
                                .text(function () { return d.name; });
                        } else {
                            var top = d.name.substring(0, 4);
                            var bot = d.name.substring(4, d.name.length);
                            d3.select(this).text(function () { return ''; });
                            d3.select(this).append('tspan')
                                .attr('x', 0)
                                .attr('y', -7)
                                .text(function () { return top; });
                            d3.select(this).append('tspan')
                                .attr('x', 0)
                                .attr('y', 10)
                                .text(function () { return bot; });
                        }
                    });
                function tick() {
                    circle.attr("transform", transform1);
                    text.attr("transform", transform2);
                    edges_line.attr('d', function (d) {
                        var path = 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
                        return path;
                    });

                    edges_text.attr('transform', function (d, i) {
                        if (d.target.x < d.source.x) {
                            bbox = this.getBBox();
                            rx = bbox.x + bbox.width / 2;
                            ry = bbox.y + bbox.height / 2;
                            return 'rotate(180 ' + rx + ' ' + ry + ')';
                        }
                        else {
                            return 'rotate(0)';
                        }
                    });
                }
                function linkArc(d) {
                    return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y
                }
                function transform1(d) {
                    return "translate(" + d.x + "," + d.y + ")";
                }
                function transform2(d) {
                    return "translate(" + (d.x) + "," + d.y + ")";
                }
            </script>

        </div>
    </div>
</div>
-->

<div class="container">
    <div class="row">
        <div class="col-lg-12" style="height:500px;" id="graph">
            
        </div>
    </div>
</div>

<script type="text/javascript">

    $(document).keypress(function (e) {
        // press 'enter' ,then execute the function
        if (e.which == 13) {
            search();
        }
    });

    window.onresize = function () {
        //resize the graph area
        myChart.resize();
    }

    //lock the web browser
    $.ajaxSetup({ async: false });

    var myChart = echarts.init(document.getElementById("graph"));

    //show the loading process
    myChart.showLoading();
    myChart.hideLoading();

    option = {
        // backgroundColor: "white",
        title: {
            text: '搜索结果',
            show:false,
            textStyle: {
                color: "black",
                fontWeight: "lighter",
            }
        },
        animationDurationUpdate: 1500,
        animationEasingUpdate: 'quinticInOut',
        legend: {
            x: "center",
            show: true,
            backgroundColor: "#E0E0E0",
            borderColor:"#707070",
            data: ['center', 'end']
        },
        //set legend ,disable
        series: [
            {
                type: 'graph',
                layout: 'force',
                symbolSize: 100,
                edgeSymbol: ['circle', 'arrow'],
                edgeSymbolSize: [4, 4],
                edgeLabel: {
                    show: true,
                    color:"#00000",
                    fontSize: 12,
                },
                force: {
                    repulsion: 2500,
                    edgeLength: [10, 20]
                },
                focusNodeAdjacency: true,
                draggable: true,
                roam: true,
                categories: [{
                    name: 'center',
                    itemStyle: {
                        color: "#FF1919",
                    }
                },
                {
                    name: 'end',
                    itemStyle: {
                        color: "#1956FF",
                    }
                }

                ],
                //set node's categories ,disable
                label: {
                    show: true,
                    color:"#000000",
                    fontSize: 20
                },
                lineStyle: {
                    color:"#FFF639",
                    opacity: 0,
                    width: 2,
                    curveness: 0.3
                },
                // progressiveThreshold: 700,
                nodes: [],
                links: [],
            }
        ]
    };

    //interact with back end
    function search() {

        $.getJSON('/entity_search', {
            entity: $("#search").val(),

        }, function (json) {

            option.series[0].nodes = json.data.map(function (node, idx) {
                node.id = idx;
                return node;
            });

            option.series[0].links = json.links;

            myChart.setOption(option, true);

        });
    }
</script>

{% endblock %}
